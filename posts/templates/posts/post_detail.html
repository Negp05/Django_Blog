{% extends "base.html" %}
{% block title %}{{ post.titulo }} · THE VORTEX BLOG{% endblock %}

{% block content %}
<article class="card shadow-sm border-0">
  <div class="card-body p-4 p-md-5">
    <h1 class="h2 mb-2">{{ post.titulo }}</h1>
    <p class="text-secondary small mb-4">
      Por {{ post.autor }} · {{ post.creado|date:"d M Y" }}
    </p>

    <div class="fs-5">
      {{ post.contenido|linebreaks }}
    </div>

    {# === BLOQUE DE REACCIONES + GUARDADO === #}
<div class="d-flex align-items-center gap-2 mt-4"
     id="reactions-{{ post.id }}"
     data-model="posts.Post"
     data-id="{{ post.id }}">

    <form style="display:none">{% csrf_token %}</form>
    

  <button class="btn btn-sm btn-outline-secondary react" data-kind="like">👍 Me gusta</button>
  <button class="btn btn-sm btn-outline-secondary react" data-kind="love">❤️ Me encanta</button>
  <button class="btn btn-sm btn-outline-secondary react" data-kind="wow">😮 Wow</button>
  <form id="csrf-holder" style="display:none">{% csrf_token %}</form>


  <span class="ms-2 text-secondary small counts">
    {% if reaction_counts %}
      {% for k,v in reaction_counts.items %}
        {{ k }}: {{ v }}{% if not forloop.last %} · {% endif %}
      {% endfor %}
    {% endif %}
  </span>

    <button
    class="btn btn-sm {% if is_bookmarked %}btn-primary{% else %}btn-outline-primary{% endif %} ms-3 bookmark"
    data-model="posts.Post"
    data-id="{{ post.id }}"
    >
    {% if is_bookmarked %}Guardado ✓{% else %}Guardar{% endif %}
    </button>


</div>
{# === FIN BLOQUE DE REACCIONES === #}


    <div class="d-flex gap-2 mt-4">
      <a href="{% url 'posts:post_list' %}" class="btn btn-outline-secondary">Volver a la lista</a>

      {% if user.is_authenticated and user == post.autor %}
        <a href="{% url 'posts:post_update' post.slug %}" class="btn btn-outline-primary">Editar</a>
        <a href="{% url 'posts:post_delete' post.slug %}" class="btn btn-outline-danger">Eliminar</a>
      {% endif %}
    </div>
  </div>
</article>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) CSRF desde el input generado por {% csrf_token %}
    const csrfInput = document.querySelector('#csrf-holder input[name=csrfmiddlewaretoken]');
    const csrftoken = csrfInput ? csrfInput.value : null;

    async function postJSON(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      // Debug útil
      console.log('POST', url, '->', res.status);
      if (!res.ok) {
        const txt = await res.text();
        console.error('Respuesta:', txt);
        alert('Error ' + res.status + ' (mira F12 > Network/Console)');
        return null;
      }
      return res.json();
    }

    // 2) Reacciones
    document.querySelectorAll('.react').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const box = e.target.closest('[id^="reactions-"]');
        const data = await postJSON("{% url 'social:toggle_reaction' %}", {
          model: box.dataset.model,   // <-- debe ser "posts.Post" si tu app es 'posts'
          id: box.dataset.id,
          kind: e.target.dataset.kind
        });
        if (data && data.ok) {
          const text = Object.entries(data.counts).map(([k,v]) => `${k}: ${v}`).join(' · ');
          box.querySelector('.counts').textContent = text || '';
        }
      });
    });

    // 3) Guardado (bookmark)
    document.querySelectorAll('.bookmark').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const data = await postJSON("{% url 'social:toggle_bookmark' %}", {
          model: e.target.dataset.model, // idem arriba
          id: e.target.dataset.id
        });
        if (data && data.ok) e.target.textContent = data.added ? 'Guardado ✓' : 'Guardar';
      });
    });
  });
</script>


{% endblock %}