{% extends "base.html" %}
{% block title %}Posts ¬∑ THE VORTEX BLOG{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 m-0">Posts publicados</h1>
  {% if user.is_authenticated %}
    <a href="{% url 'posts:post_create' %}" class="btn btn-primary">Crear nuevo post</a>
  {% endif %}
</div>

{% if posts %}
  <div class="row g-4">
    {% for post in posts %}
      <div class="col-12 col-md-6 col-lg-4">
        <article class="card h-100 post-card shadow-sm border-0">
          <div class="card-body">
            <h2 class="h5">
              <a class="link-dark text-decoration-none" href="{% url 'posts:post_detail' post.slug %}">
                {{ post.titulo }}
              </a>
            </h2>
            <p class="text-secondary small mb-2">
              Por {{ post.autor }} ¬∑ {{ post.creado|date:"d M Y" }}
            </p>
            <p class="text-secondary">{{ post.contenido|truncatewords:30 }}</p>

            {# Si ya calculas likes/loves/wows en la vista, puedes mostrarlos aqu√≠ #}
            {# <p class="mt-2 mb-0"> üëç {{ post.likes }} ¬∑ ‚ù§Ô∏è {{ post.loves }} ¬∑ üòÆ {{ post.wows }} </p> #}
          </div>

          <div class="card-footer bg-white border-0 d-flex gap-2">
            <a href="{% url 'posts:post_detail' post.slug %}" class="btn btn-sm btn-outline-primary">
              Leer m√°s
            </a>

            {# Bot√≥n Guardar/Guardado con estado inicial correcto #}
            <button
              class="btn btn-sm {% if post.is_bookmarked %}btn-primary{% else %}btn-outline-primary{% endif %} bookmark"
              data-model="posts.Post"
              data-id="{{ post.id }}"
            >
              {% if post.is_bookmarked %}Guardado ‚úì{% else %}Guardar{% endif %}
            </button>
          </div>
        </article>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-secondary">A√∫n no hay posts publicados.</div>
{% endif %}

{# --- CSRF holder para que el JS obtenga el token --- #}
<form id="csrf-holder" style="display:none">{% csrf_token %}</form>

{# --- JS: va al final del template (aqu√≠ mismo) --- #}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tomamos el token desde el input generado por {% csrf_token %}
    const csrfInput = document.querySelector('#csrf-holder input[name=csrfmiddlewaretoken]');
    const csrftoken = csrfInput ? csrfInput.value : null;

    async function postJSON(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      if (!res.ok) return null;
      return res.json();
    }

    // Toggle Guardar/Guardado
    document.querySelectorAll('.bookmark').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const el = e.currentTarget;
        const data = await postJSON("{% url 'social:toggle_bookmark' %}", {
          model: el.dataset.model,   // "posts.Post" si tu app-model es ese
          id: el.dataset.id
        });
        if (!data || !data.ok) return;

        if (data.added) {
          // Se guard√≥
          el.textContent = 'Guardado ‚úì';
          el.classList.remove('btn-outline-primary');
          el.classList.add('btn-primary');
        } else {
          // Se quit√≥ de guardados
          el.textContent = 'Guardar';
          el.classList.remove('btn-primary');
          el.classList.add('btn-outline-primary');
        }
      });
    });
  });
</script>
{% endblock %}
